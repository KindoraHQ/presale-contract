name: CI

on:
  push:
    branches:
      - main
      - master
      - '**'
  pull_request:
    branches:
      - main
      - master
      - '**'

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        node-version: [18.x]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Detect project type
        id: detect
        run: |
          echo "Detecting project type..."
          
          # Check for package manager lock files
          if [ -f "package-lock.json" ]; then
            echo "lock_file=package-lock.json" >> $GITHUB_OUTPUT
            echo "install_cmd=npm ci" >> $GITHUB_OUTPUT
          elif [ -f "pnpm-lock.yaml" ]; then
            echo "lock_file=pnpm-lock.yaml" >> $GITHUB_OUTPUT
            echo "install_cmd=pnpm install --frozen-lockfile" >> $GITHUB_OUTPUT
          elif [ -f "yarn.lock" ]; then
            echo "lock_file=yarn.lock" >> $GITHUB_OUTPUT
            echo "install_cmd=yarn install --frozen-lockfile" >> $GITHUB_OUTPUT
          else
            echo "lock_file=" >> $GITHUB_OUTPUT
            echo "install_cmd=npm install" >> $GITHUB_OUTPUT
          fi
          
          # Detect project framework
          if [ -f "foundry.toml" ] || [ -d "lib/foundry" ]; then
            echo "framework=foundry" >> $GITHUB_OUTPUT
          elif [ -f "brownie-config.yaml" ]; then
            echo "framework=brownie" >> $GITHUB_OUTPUT
          elif [ -f "hardhat.config.js" ] || [ -f "hardhat.config.ts" ]; then
            echo "framework=hardhat" >> $GITHUB_OUTPUT
          elif [ -f "package.json" ]; then
            echo "framework=hardhat" >> $GITHUB_OUTPUT
          else
            echo "framework=hardhat" >> $GITHUB_OUTPUT
            echo "needs_init=true" >> $GITHUB_OUTPUT
          fi
          
          # Check for package.json scripts
          if [ -f "package.json" ]; then
            echo "has_package_json=true" >> $GITHUB_OUTPUT
            if grep -q '"compile"' package.json 2>/dev/null; then
              echo "has_compile_script=true" >> $GITHUB_OUTPUT
            fi
            if grep -q '"test"' package.json 2>/dev/null; then
              echo "has_test_script=true" >> $GITHUB_OUTPUT
            fi
            if grep -q '"lint"' package.json 2>/dev/null; then
              echo "has_lint_script=true" >> $GITHUB_OUTPUT
            fi
            if grep -q '"coverage"' package.json 2>/dev/null; then
              echo "has_coverage_script=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Cache node modules
        if: steps.detect.outputs.lock_file != ''
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles(format('**/{0}', steps.detect.outputs.lock_file)) }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install Foundry
        if: steps.detect.outputs.framework == 'foundry'
        uses: foundry-rs/foundry-toolchain@v1

      - name: Set up Python for Brownie
        if: steps.detect.outputs.framework == 'brownie'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Brownie
        if: steps.detect.outputs.framework == 'brownie'
        run: pip install eth-brownie

      - name: Initialize Hardhat project
        if: steps.detect.outputs.needs_init == 'true'
        run: |
          echo "No package.json found. Initializing Hardhat project..."
          npm init -y
          npm install --save-dev hardhat @nomicfoundation/hardhat-toolbox
          # Create minimal hardhat config
          cat > hardhat.config.js << 'EOF'
          require("@nomicfoundation/hardhat-toolbox");
          
          /** @type import('hardhat/config').HardhatUserConfig */
          module.exports = {
            solidity: "0.8.20",
            paths: {
              sources: "./contracts",
            },
          };
          EOF

      - name: Install dependencies
        if: steps.detect.outputs.has_package_json == 'true' || steps.detect.outputs.needs_init == 'true'
        run: ${{ steps.detect.outputs.install_cmd || 'npm install' }}

      - name: Compile contracts
        run: |
          if [ "${{ steps.detect.outputs.framework }}" = "foundry" ]; then
            forge build
          elif [ "${{ steps.detect.outputs.framework }}" = "brownie" ]; then
            brownie compile
          elif [ "${{ steps.detect.outputs.has_compile_script }}" = "true" ]; then
            npm run compile
          else
            npx hardhat compile
          fi

      - name: Run linter
        run: |
          SOLHINT_CMD="npx solhint 'contracts/**/*.sol' || true"
          if [ "${{ steps.detect.outputs.has_lint_script }}" = "true" ]; then
            npm run lint
          elif command -v solhint &> /dev/null || [ -f "node_modules/.bin/solhint" ]; then
            eval $SOLHINT_CMD
          else
            echo "No linter configured. Installing and running solhint..."
            npm install --save-dev solhint
            eval $SOLHINT_CMD
          fi

      - name: Run tests
        run: |
          if [ "${{ steps.detect.outputs.framework }}" = "foundry" ]; then
            forge test
          elif [ "${{ steps.detect.outputs.framework }}" = "brownie" ]; then
            brownie test
          elif [ "${{ steps.detect.outputs.has_test_script }}" = "true" ]; then
            npm test
          else
            npx hardhat test || echo "No tests found or test directory not configured"
          fi

      - name: Generate coverage
        if: steps.detect.outputs.has_coverage_script == 'true'
        run: npm run coverage
        continue-on-error: true

      - name: Upload coverage artifacts
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          if-no-files-found: ignore

      - name: Run Slither static analysis
        uses: crytic/slither-action@v0.4.0
        id: slither
        continue-on-error: true
        with:
          fail-on: none
          slither-args: --json slither-report.json

      - name: Upload Slither report
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: slither-report
          path: slither-report.json
          if-no-files-found: ignore
